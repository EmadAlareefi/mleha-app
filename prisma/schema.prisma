generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // e.g. postgresql://USER:PASSWORD@HOST:PORT/DB?sslmode=require
}

model WebhookEvent {
  id           String   @id @default(cuid())
  sallaEvent   String
  orderId      String?
  status       String?
  rawPayload   Json      // maps to jsonb in Postgres
  signature    String?
  receivedAt   DateTime  @default(now())
  uniqueKey    String?   @unique

  @@index([receivedAt])
  @@index([orderId, status])
}

model MessageLog {
  id           String   @id @default(cuid())
  orderId      String?
  toPhone      String
  channel      String   // "whatsapp"
  templateName String?
  body         String?  @db.Text   // body can be long; TEXT avoids length limits
  zokoMsgId    String?
  status       String   // "sent" | "failed"
  error        String?  @db.Text   // store full error safely
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([orderId])
}

model WebhookLog {
  id              String   @id @default(cuid())
  receivedAt      DateTime @default(now())

  // Request metadata
  method          String
  url             String?
  ip              String?  @db.Inet
  headers         Json     // jsonb

  // Signature
  signature       String?
  signatureHeader String?
  verified        Boolean

  // Parsed info (best effort)
  event           String?
  orderId         String?
  status          String?

  // Payload
  rawText         String   @db.Text  // always store the raw body (no length cap)
  json            Json?              // set only when JSON parse succeeds (jsonb)

  // Errors
  parseError      String?  @db.Text

  @@index([receivedAt])
  @@index([event])
  @@index([orderId, status])
}

model Shipment {
  id              String   @id @default(cuid())
  trackingNumber  String   @unique
  company         String   // Detected company (e.g., "aramex", "smsa", "dhl", etc.)
  type            String   // "incoming" or "outgoing"
  scannedAt       DateTime @default(now())
  scannedBy       String?  // Optional: user who scanned
  notes           String?  @db.Text

  @@index([scannedAt])
  @@index([company])
  @@index([type])
  @@index([scannedAt, type])
}

model SallaAuth {
  id                String   @id @default(cuid())
  merchantId        String   @unique // Salla merchant ID
  accessToken       String   @db.Text
  refreshToken      String   @db.Text
  expiresAt         DateTime // When the access token expires
  scope             String?  // Permissions scope
  tokenType         String   @default("bearer")

  // Token refresh management
  isRefreshing      Boolean  @default(false) // Mutex flag to prevent parallel refreshes
  lastRefreshedAt   DateTime @default(now())
  refreshAttempts   Int      @default(0) // Counter for failed refresh attempts

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([expiresAt])
  @@index([isRefreshing])
}

model ReturnRequest {
  id                String   @id @default(cuid())
  merchantId        String   // Salla merchant ID
  orderId           String   // Salla order ID
  orderNumber       String?  // Human-readable order number
  customerId        String?  // Salla customer ID
  customerName      String?
  customerEmail     String?
  customerPhone     String?

  type              String   // "return" or "exchange"
  status            String   @default("pending_review") // pending_review, approved, rejected, shipped, delivered, completed, cancelled
  reason            String   // Predefined reason or "other"
  reasonDetails     String?  @db.Text // Free-text explanation

  // SMSA shipment info
  smsaTrackingNumber String?  @unique
  smsaAwbNumber      String?
  smsaResponse       Json?    // Raw SMSA API response

  // Financial details
  totalRefundAmount  Decimal? @db.Decimal(10, 2)
  returnFee          Decimal? @db.Decimal(10, 2) // Return processing fee
  shippingAmount     Decimal? @db.Decimal(10, 2) // Original shipping cost (non-refundable)

  // Coupon for exchanges
  couponCode         String?  @unique // Generated coupon code for exchanges
  couponId           String?  // Salla coupon ID
  couponCreatedAt    DateTime? // When coupon was created

  // Admin notes
  adminNotes         String?  @db.Text
  reviewedBy         String?  // Admin who reviewed
  reviewedAt         DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  items             ReturnItem[]

  @@index([merchantId])
  @@index([orderId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([smsaTrackingNumber])
}

model ReturnItem {
  id                String   @id @default(cuid())
  returnRequestId   String
  returnRequest     ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)

  productId         String   // Salla product ID
  productName       String
  productSku        String?
  variantId         String?  // If product has variants
  variantName       String?
  quantity          Int
  price             Decimal  @db.Decimal(10, 2)

  createdAt         DateTime @default(now())

  @@index([returnRequestId])
  @@index([productId])
}

model Settings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model LocalShipment {
  id                String   @id @default(cuid())
  merchantId        String   // Salla merchant ID
  orderId           String   // Salla order ID
  orderNumber       String   // Human-readable order number

  // Customer/Shipping Info
  customerName      String
  customerPhone     String
  shippingAddress   String   @db.Text
  shippingCity      String
  shippingPostcode  String?

  // Order Info
  orderTotal        Decimal  @db.Decimal(10, 2)
  itemsCount        Int
  orderItems        Json?    // Store order items for label display

  // Label Info
  trackingNumber    String   @unique // Generated local tracking number
  generatedBy       String?  // User who generated the label
  notes             String?  @db.Text

  createdAt         DateTime @default(now())

  @@index([merchantId])
  @@index([orderId])
  @@index([trackingNumber])
  @@index([createdAt])
}

model OrderUser {
  id              String   @id @default(cuid())
  username        String   @unique
  password        String   // Hashed password
  name            String
  email           String?
  phone           String?

  // Order type assignment
  orderType       String   // "all", "cod", "prepaid", "specific_status"
  specificStatus  String?  // If orderType is "specific_status"

  // Settings
  isActive        Boolean  @default(true)
  autoAssign      Boolean  @default(true) // Auto-assign orders when user logs in
  maxOrders       Int      @default(50)   // Max orders to assign at once

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  assignments     OrderAssignment[]

  @@index([username])
  @@index([isActive])
}

model OrderAssignment {
  id              String   @id @default(cuid())

  // User
  userId          String
  user            OrderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Order info
  merchantId      String
  orderId         String   // Salla order ID
  orderNumber     String   // Human-readable order number
  orderData       Json     // Full order data from Salla

  // Assignment details
  status          String   @default("assigned") // assigned, preparing, prepared, completed, cancelled, removed
  assignedAt      DateTime @default(now())
  startedAt       DateTime? // When user started preparing
  completedAt     DateTime? // When user marked as prepared
  removedAt       DateTime? // When order was removed (status changed in Salla)

  // Salla status tracking
  sallaStatus     String?  // Current status in Salla
  sallaUpdated    Boolean  @default(false) // Whether we updated status in Salla

  notes           String?  @db.Text

  @@index([userId])
  @@index([status])
  @@index([merchantId, orderId])
  @@index([assignedAt])
  @@unique([userId, orderId])
}

model OrderHistory {
  id              String   @id @default(cuid())

  // User
  userId          String
  userName        String   // Store user name for historical reference

  // Order info
  merchantId      String
  orderId         String   // Salla order ID
  orderNumber     String   // Human-readable order number
  orderData       Json     // Full order data from Salla

  // History details
  status          String   // Final status: completed, cancelled, removed
  assignedAt      DateTime
  startedAt       DateTime?
  finishedAt      DateTime // When order was finished/removed

  // Duration tracking
  durationMinutes Int?     // Total time spent on order

  // Salla status at finish
  finalSallaStatus String?

  notes           String?  @db.Text

  @@index([userId])
  @@index([status])
  @@index([merchantId, orderId])
  @@index([finishedAt])
  @@index([assignedAt])
}
