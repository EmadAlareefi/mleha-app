generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // e.g. postgresql://USER:PASSWORD@HOST:PORT/DB?sslmode=require
}

model WebhookEvent {
  id         String   @id @default(cuid())
  sallaEvent String
  orderId    String?
  status     String?
  rawPayload Json // maps to jsonb in Postgres
  signature  String?
  receivedAt DateTime @default(now())
  uniqueKey  String?  @unique

  @@index([receivedAt])
  @@index([orderId, status])
}

model MessageLog {
  id           String   @id @default(cuid())
  orderId      String?
  toPhone      String
  channel      String // "whatsapp"
  templateName String?
  body         String?  @db.Text // body can be long; TEXT avoids length limits
  zokoMsgId    String?
  status       String // "sent" | "failed"
  error        String?  @db.Text // store full error safely
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([orderId])
}

model WebhookLog {
  id         String   @id @default(cuid())
  receivedAt DateTime @default(now())

  // Request metadata
  method  String
  url     String?
  ip      String? @db.Inet
  headers Json // jsonb

  // Signature
  signature       String?
  signatureHeader String?
  verified        Boolean

  // Parsed info (best effort)
  event   String?
  orderId String?
  status  String?

  // Payload
  rawText String @db.Text // always store the raw body (no length cap)
  json    Json? // set only when JSON parse succeeds (jsonb)

  // Errors
  parseError String? @db.Text

  @@index([receivedAt])
  @@index([event])
  @@index([orderId, status])
}

model Shipment {
  id             String     @id @default(cuid())
  trackingNumber String     @unique
  company        String // Detected company (e.g., "aramex", "smsa", "dhl", etc.)
  type           String // "incoming" or "outgoing"
  scannedAt      DateTime   @default(now())
  scannedBy      String? // Optional: user who scanned
  notes          String?    @db.Text
  warehouseId    String?
  warehouse      Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  @@index([scannedAt])
  @@index([company])
  @@index([type])
  @@index([scannedAt, type])
  @@index([warehouseId])
}

model SallaAuth {
  id           String   @id @default(cuid())
  merchantId   String   @unique // Salla merchant ID
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  expiresAt    DateTime // When the access token expires
  scope        String? // Permissions scope
  tokenType    String   @default("bearer")

  // Token refresh management
  isRefreshing    Boolean  @default(false) // Mutex flag to prevent parallel refreshes
  lastRefreshedAt DateTime @default(now())
  refreshAttempts Int      @default(0) // Counter for failed refresh attempts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
  @@index([isRefreshing])
}

model SallaInvoice {
  id              String    @id @default(cuid())
  merchantId      String
  invoiceId       String
  orderId         String?
  orderNumber     String?
  invoiceNumber   String?
  status          String?
  paymentStatus   String?
  currency        String?
  subtotalAmount  Decimal?  @db.Decimal(12, 2)
  taxAmount       Decimal?  @db.Decimal(12, 2)
  totalAmount     Decimal?  @db.Decimal(12, 2)
  shippingAmount  Decimal?  @db.Decimal(12, 2)
  discountAmount  Decimal?  @db.Decimal(12, 2)
  issueDate       DateTime?
  dueDate         DateTime?
  customerId      String?
  customerName    String?
  customerMobile  String?
  customerEmail   String?
  notes           String?   @db.Text
  rawInvoice      Json
  rawOrder        Json?
  erpSyncedAt     DateTime?
  erpSyncError    String?   @db.Text
  erpSyncAttempts Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([merchantId, invoiceId])
  @@index([merchantId, status])
  @@index([merchantId, orderId])
  @@index([merchantId, erpSyncedAt])
}

model SallaOrder {
  id                 String    @id @default(cuid())
  merchantId         String
  orderId            String
  referenceId        String?
  orderNumber        String?
  statusSlug         String?
  statusName         String?
  fulfillmentStatus  String?
  paymentStatus      String?
  currency           String?
  subtotalAmount     Decimal?  @db.Decimal(12, 2)
  taxAmount          Decimal?  @db.Decimal(12, 2)
  shippingAmount     Decimal?  @db.Decimal(12, 2)
  discountAmount     Decimal?  @db.Decimal(12, 2)
  totalAmount        Decimal?  @db.Decimal(12, 2)
  customerId         String?
  customerName       String?
  customerMobile     String?
  customerEmail      String?
  customerCity       String?
  customerCountry    String?
  paymentMethod      String?
  fulfillmentCompany String?
  trackingNumber     String?
  placedAt           DateTime?
  updatedAtRemote    DateTime?
  rawOrder           Json

  // Campaign tracking
  campaignSource String?
  campaignMedium String?
  campaignName   String?

  // ERP sync tracking
  erpSyncedAt     DateTime?
  erpInvoiceId    String?
  erpSyncError    String?   @db.Text
  erpSyncAttempts Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([merchantId, orderId])
  @@index([merchantId, placedAt])
  @@index([merchantId, statusSlug])
  @@index([merchantId, erpSyncedAt])
  @@index([merchantId, campaignSource])
  @@index([merchantId, campaignName])
}

model ReturnRequest {
  id            String  @id @default(cuid())
  merchantId    String // Salla merchant ID
  orderId       String // Salla order ID
  orderNumber   String? // Human-readable order number
  customerId    String? // Salla customer ID
  customerName  String?
  customerEmail String?
  customerPhone String?

  type          String // "return" or "exchange"
  status        String  @default("pending_review") // pending_review, approved, rejected, shipped, delivered, completed, cancelled
  reason        String // Predefined reason or "other"
  reasonDetails String? @db.Text // Free-text explanation

  // SMSA shipment info
  smsaTrackingNumber String? @unique
  smsaAwbNumber      String?
  smsaResponse       Json? // Raw SMSA API response

  // Financial details
  totalRefundAmount Decimal? @db.Decimal(10, 2)
  returnFee         Decimal? @db.Decimal(10, 2) // Return processing fee
  shippingAmount    Decimal? @db.Decimal(10, 2) // Original shipping cost (non-refundable)

  // Coupon for exchanges
  couponCode      String?   @unique // Generated coupon code for exchanges
  couponId        String? // Salla coupon ID
  couponCreatedAt DateTime? // When coupon was created

  // Admin notes
  adminNotes String?   @db.Text
  reviewedBy String? // Admin who reviewed
  reviewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items ReturnItem[]

  @@index([merchantId])
  @@index([orderId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([smsaTrackingNumber])
}

model ReturnItem {
  id              String        @id @default(cuid())
  returnRequestId String
  returnRequest   ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)

  productId   String // Salla product ID
  productName String
  productSku  String?
  variantId   String? // If product has variants
  variantName String?
  quantity    Int
  price       Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([returnRequestId])
  @@index([productId])
}

model Settings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model LocalShipment {
  id          String @id @default(cuid())
  merchantId  String // Salla merchant ID
  orderId     String // Salla order ID
  orderNumber String // Human-readable order number

  // Customer/Shipping Info
  customerName     String
  customerPhone    String
  shippingAddress  String  @db.Text
  shippingCity     String
  shippingPostcode String?

  // Order Info
  orderTotal Decimal @db.Decimal(10, 2)
  itemsCount Int
  orderItems Json? // Store order items for label display

  // Payment Method
  paymentMethod String  @default("prepaid") // "cod" or "prepaid"
  isCOD         Boolean @default(false) // True if cash on delivery

  // Shipment Status
  status             String    @default("pending") // pending, assigned, picked_up, in_transit, delivered, cancelled
  deliveryNotes      String?   @db.Text
  deliveredAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?   @db.Text

  // Label Info
  trackingNumber String     @unique // Generated local tracking number
  generatedBy    String? // User who generated the label
  notes          String?    @db.Text
  warehouseId    String?
  warehouse      Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  assignment    ShipmentAssignment?
  codCollection CODCollection?

  @@index([merchantId])
  @@index([orderId])
  @@index([trackingNumber])
  @@index([createdAt])
  @@index([warehouseId])
  @@index([status])
  @@index([isCOD])
}

enum OrderUserRole {
  ORDERS
  STORE_MANAGER
  WAREHOUSE
  ACCOUNTANT
  DELIVERY_AGENT
}

model OrderUser {
  id       String        @id @default(cuid())
  username String        @unique
  password String // Hashed password
  name     String
  email    String?
  phone    String?
  role     OrderUserRole @default(ORDERS) // @deprecated - use roleAssignments instead

  // Order type assignment
  orderType      String // "all", "cod", "prepaid", "specific_status"
  specificStatus String? // If orderType is "specific_status"

  // Settings
  isActive   Boolean @default(true)
  autoAssign Boolean @default(true) // Auto-assign orders when user logs in
  maxOrders  Int     @default(50) // Max orders to assign at once

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments          OrderAssignment[]
  warehouseAssignments WarehouseAssignment[]
  roleAssignments      UserRoleAssignment[]
  deliveryAssignments  ShipmentAssignment[]  @relation("DeliveryAssignments")

  @@index([username])
  @@index([isActive])
}

// New table for multiple role support
model UserRoleAssignment {
  id     String        @id @default(cuid())
  userId String
  role   OrderUserRole

  assignedAt DateTime @default(now())
  assignedBy String? // Username of admin who assigned this role

  user OrderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([userId])
  @@index([role])
}

model OrderAssignment {
  id String @id @default(cuid())

  // User
  userId String
  user   OrderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Order info
  merchantId  String
  orderId     String // Salla order ID
  orderNumber String // Human-readable order number
  orderData   Json // Full order data from Salla

  // Assignment details
  status      String    @default("assigned") // assigned, preparing, prepared, completed, cancelled, removed
  assignedAt  DateTime  @default(now())
  startedAt   DateTime? // When user started preparing
  completedAt DateTime? // When user marked as prepared
  removedAt   DateTime? // When order was removed (status changed in Salla)

  // Salla status tracking
  sallaStatus  String? // Current status in Salla
  sallaUpdated Boolean @default(false) // Whether we updated status in Salla

  notes String? @db.Text

  @@unique([userId, orderId])
  @@index([userId])
  @@index([status])
  @@index([merchantId, orderId])
  @@index([assignedAt])
}

model Warehouse {
  id          String   @id @default(cuid())
  name        String
  code        String?  @unique
  location    String?
  description String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shipments      Shipment[]
  localShipments LocalShipment[]
  assignments    WarehouseAssignment[]

  @@index([isActive])
}

model WarehouseAssignment {
  id          String   @id @default(cuid())
  userId      String
  warehouseId String
  role        String?
  createdAt   DateTime @default(now())

  user      OrderUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([userId, warehouseId])
  @@index([warehouseId])
}

model OrderHistory {
  id String @id @default(cuid())

  // User
  userId   String
  userName String // Store user name for historical reference

  // Order info
  merchantId  String
  orderId     String // Salla order ID
  orderNumber String // Human-readable order number
  orderData   Json // Full order data from Salla

  // History details
  status     String // Final status: completed, cancelled, removed
  assignedAt DateTime
  startedAt  DateTime?
  finishedAt DateTime // When order was finished/removed

  // Duration tracking
  durationMinutes Int? // Total time spent on order

  // Salla status at finish
  finalSallaStatus String?

  notes String? @db.Text

  @@index([userId])
  @@index([status])
  @@index([merchantId, orderId])
  @@index([finishedAt])
  @@index([assignedAt])
}

model Expense {
  id String @id @default(cuid())

  // Basic info
  merchantId  String // Salla merchant ID
  title       String // Expense title/description
  description String? @db.Text // Optional detailed description

  // Financial details
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("SAR")

  // Category
  category String // e.g., "shipping", "packaging", "marketing", "operations", "other"

  // Date
  expenseDate DateTime @default(now()) // Date of expense

  // Attachments
  attachments Json? // Array of attachment URLs/metadata

  // Tracking
  createdBy String // User who created the expense
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Approval workflow (optional for future)
  status     String    @default("pending") // pending, approved, rejected
  approvedBy String? // User who approved/rejected
  approvedAt DateTime?

  // Notes
  notes String? @db.Text

  @@index([merchantId])
  @@index([category])
  @@index([expenseDate])
  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
}

model ShipmentAssignment {
  id String @id @default(cuid())

  // Shipment
  shipmentId String        @unique
  shipment   LocalShipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  // Delivery Agent
  deliveryAgentId String
  deliveryAgent   OrderUser @relation("DeliveryAssignments", fields: [deliveryAgentId], references: [id], onDelete: Cascade)

  // Assignment details
  status      String    @default("assigned") // assigned, picked_up, in_transit, delivered, failed, cancelled
  assignedAt  DateTime  @default(now())
  assignedBy  String? // Admin who assigned
  pickedUpAt  DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?
  cancelledAt DateTime?

  // Failure/cancellation details
  failureReason      String? @db.Text
  cancellationReason String? @db.Text

  // Delivery proof
  deliveryProofUrl   String? // Photo of delivery proof
  recipientName      String? // Name of person who received
  recipientSignature String? // Signature URL (if captured)

  // Notes
  notes String? @db.Text

  updatedAt DateTime @updatedAt

  @@index([deliveryAgentId])
  @@index([status])
  @@index([assignedAt])
  @@index([deliveredAt])
}

model CODCollection {
  id String @id @default(cuid())

  // Shipment
  shipmentId String        @unique
  shipment   LocalShipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  // Collection details
  collectionAmount Decimal  @db.Decimal(10, 2) // Amount to collect from customer
  collectedAmount  Decimal? @db.Decimal(10, 2) // Actual amount collected
  currency         String   @default("SAR")

  // Collection status
  status       String    @default("pending") // pending, collected, deposited, reconciled, failed
  collectedAt  DateTime? // When delivery agent collected from customer
  depositedAt  DateTime? // When delivery agent deposited to warehouse/company
  reconciledAt DateTime? // When accounting reconciled

  // Collected by
  collectedBy  String? // Delivery agent who collected
  depositedBy  String? // User who recorded deposit
  reconciledBy String? // Accountant who reconciled

  // Payment proof
  receiptUrl String? // Photo of receipt

  // Deposit details
  depositMethod    String? // "cash", "bank_transfer", "mobile_wallet"
  depositReference String? // Bank reference number or transaction ID
  depositNotes     String? @db.Text

  // Reconciliation details
  reconciliationNotes String?  @db.Text
  discrepancyAmount   Decimal? @db.Decimal(10, 2) // If collected != expected
  discrepancyReason   String?  @db.Text

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([collectedAt])
  @@index([depositedAt])
  @@index([reconciledAt])
  @@index([collectedBy])
  @@index([depositedBy])
  @@index([reconciledBy])
}
