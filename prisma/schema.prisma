generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // e.g. postgresql://USER:PASSWORD@HOST:PORT/DB?sslmode=require
}

model WebhookEvent {
  id           String   @id @default(cuid())
  sallaEvent   String
  orderId      String?
  status       String?
  rawPayload   Json      // maps to jsonb in Postgres
  signature    String?
  receivedAt   DateTime  @default(now())
  uniqueKey    String?   @unique

  @@index([receivedAt])
  @@index([orderId, status])
}

model MessageLog {
  id           String   @id @default(cuid())
  orderId      String?
  toPhone      String
  channel      String   // "whatsapp"
  templateName String?
  body         String?  @db.Text   // body can be long; TEXT avoids length limits
  zokoMsgId    String?
  status       String   // "sent" | "failed"
  error        String?  @db.Text   // store full error safely
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([orderId])
}

model WebhookLog {
  id              String   @id @default(cuid())
  receivedAt      DateTime @default(now())

  // Request metadata
  method          String
  url             String?
  ip              String?  @db.Inet
  headers         Json     // jsonb

  // Signature
  signature       String?
  signatureHeader String?
  verified        Boolean

  // Parsed info (best effort)
  event           String?
  orderId         String?
  status          String?

  // Payload
  rawText         String   @db.Text  // always store the raw body (no length cap)
  json            Json?              // set only when JSON parse succeeds (jsonb)

  // Errors
  parseError      String?  @db.Text

  @@index([receivedAt])
  @@index([event])
  @@index([orderId, status])
}
