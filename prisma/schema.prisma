generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // change to "postgresql" for Neon
  url      = env("DATABASE_URL")
}

model WebhookEvent {
  id           String   @id @default(cuid())
  sallaEvent   String
  orderId      String?
  status       String?
  rawPayload   Json
  signature    String?
  receivedAt   DateTime @default(now())
  uniqueKey    String?  @unique
}

model MessageLog {
  id           String   @id @default(cuid())
  orderId      String?
  toPhone      String
  channel      String   // "whatsapp"
  templateName String?
  body         String?
  zokoMsgId    String?
  status       String   // "sent" | "failed"
  error        String?
  createdAt    DateTime @default(now())
}

model WebhookLog {
  id              String   @id @default(cuid())
  receivedAt      DateTime @default(now())

  // Request metadata
  method          String
  url             String?
  ip              String?
  headers         Json

  // Signature
  signature       String?
  signatureHeader String?
  verified        Boolean

  // Parsed info (best effort)
  event           String?
  orderId         String?
  status          String?

  // Payload
  rawText         String    // always store the raw body
  json            Json?     // set only when JSON parse succeeds

  // Errors
  parseError      String?

  @@index([receivedAt])
  @@index([event])
  @@index([orderId, status])
}
