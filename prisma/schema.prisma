generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // e.g. postgresql://USER:PASSWORD@HOST:PORT/DB?sslmode=require
}

model WebhookEvent {
  id         String   @id @default(cuid())
  sallaEvent String
  orderId    String?
  status     String?
  rawPayload Json // maps to jsonb in Postgres
  signature  String?
  receivedAt DateTime @default(now())
  uniqueKey  String?  @unique

  @@index([receivedAt])
  @@index([orderId, status])
}

model MessageLog {
  id           String   @id @default(cuid())
  orderId      String?
  toPhone      String
  channel      String // "whatsapp"
  templateName String?
  body         String?  @db.Text // body can be long; TEXT avoids length limits
  zokoMsgId    String?
  status       String // "sent" | "failed"
  error        String?  @db.Text // store full error safely
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([orderId])
}

model WebhookLog {
  id         String   @id @default(cuid())
  receivedAt DateTime @default(now())

  // Request metadata
  method  String
  url     String?
  ip      String? @db.Inet
  headers Json // jsonb

  // Signature
  signature       String?
  signatureHeader String?
  verified        Boolean

  // Parsed info (best effort)
  event   String?
  orderId String?
  status  String?

  // Payload
  rawText String @db.Text // always store the raw body (no length cap)
  json    Json? // set only when JSON parse succeeds (jsonb)

  // Errors
  parseError String? @db.Text

  @@index([receivedAt])
  @@index([event])
  @@index([orderId, status])
}

model Shipment {
  id             String     @id @default(cuid())
  trackingNumber String     @unique
  company        String // Detected company (e.g., "aramex", "smsa", "dhl", etc.)
  type           String // "incoming" or "outgoing"
  scannedAt      DateTime   @default(now())
  scannedBy      String? // Optional: user who scanned
  notes          String?    @db.Text
  warehouseId    String?
  warehouse      Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  @@index([scannedAt])
  @@index([company])
  @@index([type])
  @@index([scannedAt, type])
  @@index([warehouseId])
}

model SallaShipment {
  id             String   @id @default(cuid())
  merchantId     String
  orderId        String
  orderNumber    String
  trackingNumber String
  courierName    String // e.g., "SMSA Express"
  courierCode    String // e.g., "smsa"
  awbNumber      String? // Air Waybill Number
  sawb           String? // SMSA AWB
  status         String // "created", "picked_up", "in_transit", "delivered", etc.
  labelUrl       String?
  labelPrinted   Boolean  @default(false)
  labelPrintedAt DateTime?
  labelPrintedBy String?
  labelPrintedByName String?
  printJobId     String?
  printCount     Int      @default(0)
  shipmentData   Json? // Raw response from courier API
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([merchantId, orderId])
  @@index([merchantId])
  @@index([orderId])
  @@index([trackingNumber])
  @@index([createdAt])
}

model SallaAuth {
  id           String   @id @default(cuid())
  merchantId   String   @unique // Salla merchant ID
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  expiresAt    DateTime // When the access token expires
  scope        String? // Permissions scope
  tokenType    String   @default("bearer")

  // Token refresh management
  isRefreshing    Boolean  @default(false) // Mutex flag to prevent parallel refreshes
  lastRefreshedAt DateTime @default(now())
  refreshAttempts Int      @default(0) // Counter for failed refresh attempts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
  @@index([isRefreshing])
}

model SallaInvoice {
  id              String    @id @default(cuid())
  merchantId      String
  invoiceId       String
  orderId         String?
  orderNumber     String?
  invoiceNumber   String?
  status          String?
  paymentStatus   String?
  currency        String?
  subtotalAmount  Decimal?  @db.Decimal(12, 2)
  taxAmount       Decimal?  @db.Decimal(12, 2)
  totalAmount     Decimal?  @db.Decimal(12, 2)
  shippingAmount  Decimal?  @db.Decimal(12, 2)
  discountAmount  Decimal?  @db.Decimal(12, 2)
  issueDate       DateTime?
  dueDate         DateTime?
  customerId      String?
  customerName    String?
  customerMobile  String?
  customerEmail   String?
  notes           String?   @db.Text
  rawInvoice      Json
  rawOrder        Json?
  erpSyncedAt     DateTime?
  erpSyncError    String?   @db.Text
  erpSyncAttempts Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([merchantId, invoiceId])
  @@index([merchantId, status])
  @@index([merchantId, orderId])
  @@index([merchantId, erpSyncedAt])
}

model SallaOrder {
  id                 String    @id @default(cuid())
  merchantId         String
  orderId            String
  referenceId        String?
  orderNumber        String?
  statusSlug         String?
  statusName         String?
  fulfillmentStatus  String?
  paymentStatus      String?
  currency           String?
  subtotalAmount     Decimal?  @db.Decimal(12, 2)
  taxAmount          Decimal?  @db.Decimal(12, 2)
  shippingAmount     Decimal?  @db.Decimal(12, 2)
  discountAmount     Decimal?  @db.Decimal(12, 2)
  totalAmount        Decimal?  @db.Decimal(12, 2)
  customerId         String?
  customerName       String?
  customerMobile     String?
  customerEmail      String?
  customerCity       String?
  customerCountry    String?
  paymentMethod      String?
  fulfillmentCompany String?
  trackingNumber     String?
  placedAt           DateTime?
  updatedAtRemote    DateTime?
  rawOrder           Json

  // Campaign tracking
  campaignSource String?
  campaignMedium String?
  campaignName   String?
  affiliateCommission Decimal? @db.Decimal(5, 2)

  // ERP sync tracking
  erpSyncedAt     DateTime?
  erpInvoiceId    String?
  erpSyncError    String?   @db.Text
  erpSyncAttempts Int       @default(0)

  settlements OrderSettlement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([merchantId, orderId])
  @@index([merchantId, placedAt])
  @@index([merchantId, statusSlug])
  @@index([merchantId, erpSyncedAt])
  @@index([merchantId, campaignSource])
  @@index([merchantId, campaignName])
}

model SettlementUpload {
  id               String   @id @default(cuid())
  provider         String
  statementDate    DateTime?
  originalFileName String
  fileSize         Int?
  contentType      String?
  uploadedById     String?
  uploadedByName   String?
  status           String   @default("completed")
  recordCount      Int      @default(0)
  matchedCount     Int      @default(0)
  unmatchedCount   Int      @default(0)
  errorMessage     String?  @db.Text
  notes            String?  @db.Text
  fileData         Bytes?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  settlements OrderSettlement[]

  @@index([provider])
  @@index([createdAt])
}

model OrderSettlement {
  id             String    @id @default(cuid())
  uploadId       String?
  provider       String
  merchantId     String?
  orderId        String?
  orderNumber    String?
  awbNumber      String?
  paymentMethod  String?
  eventType      String?
  settlementDate DateTime?
  grossAmount    Decimal?  @db.Decimal(14, 2)
  feeAmount      Decimal?  @db.Decimal(14, 2)
  taxAmount      Decimal?  @db.Decimal(14, 2)
  netAmount      Decimal?  @db.Decimal(14, 2)
  currency       String?   @default("SAR")
  sourceReference String?
  sourceHash     String    @unique
  rawData        Json?
  linkedOrderId  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  upload     SettlementUpload? @relation(fields: [uploadId], references: [id], onDelete: SetNull)
  sallaOrder SallaOrder?       @relation(fields: [linkedOrderId], references: [id], onDelete: SetNull)

  @@index([provider])
  @@index([orderId])
  @@index([orderNumber])
  @@index([awbNumber])
  @@index([settlementDate])
}

model SallaProductLocation {
  id          String   @id @default(cuid())
  sku         String   @unique
  productId   String?
  productName String?
  merchantId  String?
  location    String
  notes       String?  @db.Text
  createdBy   String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([merchantId])
  @@index([location])
  @@index([updatedAt])
}

model SallaProductQuantityRequest {
  id               String   @id @default(cuid())
  merchantId       String?
  productId        Int
  productName      String
  productSku       String?
  productImageUrl  String?
  requestedAmount  Int
  requestedRefundAmount Int?
  requestedFrom    String
  requestedBy      String
  requestedByUser  String?
  requestedFor     DateTime?
  notes            String?  @db.Text
  status           String   @default("pending")
  requestedAt      DateTime @default(now())
  fulfilledAt      DateTime?
  providedBy       String?
  providedAmount   Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([productId, status])
  @@index([requestedAt])
}

model ReturnRequest {
  id            String  @id @default(cuid())
  merchantId    String // Salla merchant ID
  orderId       String // Salla order ID
  orderNumber   String? // Human-readable order number
  customerId    String? // Salla customer ID
  customerName  String?
  customerEmail String?
  customerPhone String?

  type          String // "return" or "exchange"
  status        String  @default("pending_review") // pending_review, approved, rejected, shipped, delivered, completed, cancelled
  reason        String // Predefined reason or "other"
  reasonDetails String? @db.Text // Free-text explanation

  // SMSA shipment info
  smsaTrackingNumber String? @unique
  smsaAwbNumber      String?
  smsaResponse       Json? // Raw SMSA API response

  // Financial details
  totalRefundAmount Decimal? @db.Decimal(10, 2)
  returnFee         Decimal? @db.Decimal(10, 2) // Return processing fee
  shippingAmount    Decimal? @db.Decimal(10, 2) // Original shipping cost (non-refundable)

  // Coupon for exchanges
  couponCode      String?   @unique // Generated coupon code for exchanges
  couponId        String? // Salla coupon ID
  couponCreatedAt DateTime? // When coupon was created

  // Exchange order tracking
  exchangeOrderId         String?
  exchangeOrderNumber     String?
  exchangeOrderLinkedAt   DateTime?
  exchangeOrderHoldActive Boolean   @default(false)
  exchangeOrderHeldAt     DateTime?
  exchangeOrderReleasedAt DateTime?

  // Admin notes
  adminNotes String?   @db.Text
  reviewedBy String? // Admin who reviewed
  reviewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items ReturnItem[]

  @@index([merchantId])
  @@index([orderId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([smsaTrackingNumber])
  @@index([exchangeOrderId])
}

model ReturnItem {
  id              String        @id @default(cuid())
  returnRequestId String
  returnRequest   ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)

  productId   String // Salla product ID
  productName String
  productSku  String?
  variantId   String? // If product has variants
  variantName String?
  quantity    Int
  price       Decimal @db.Decimal(10, 2)
  conditionStatus String?   // good, worn, missing_parts, damaged
  conditionNotes  String?   @db.Text
  inspectedBy     String?
  inspectedAt     DateTime?

  createdAt DateTime @default(now())

  @@index([returnRequestId])
  @@index([productId])
}

model Settings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model LocalShipment {
  id          String @id @default(cuid())
  merchantId  String // Salla merchant ID
  orderId     String // Salla order ID
  orderNumber String // Human-readable order number

  // Customer/Shipping Info
  customerName     String
  customerPhone    String
  shippingAddress  String  @db.Text
  shippingCity     String
  shippingPostcode String?

  // Order Info
  orderTotal Decimal @db.Decimal(10, 2)
  itemsCount Int
  orderItems Json? // Store order items for label display

  // Payment Method
  paymentMethod String  @default("prepaid") // "cod" or "prepaid"
  isCOD         Boolean @default(false) // True if cash on delivery

  // Shipment Status
  status             String    @default("pending") // pending, assigned, picked_up, in_transit, delivered, cancelled
  deliveryNotes      String?   @db.Text
  deliveredAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?   @db.Text

  // Label Info
  trackingNumber String     @unique // Generated local tracking number
  generatedBy    String? // User who generated the label
  notes          String?    @db.Text
  warehouseId    String?
  warehouse      Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  assignment    ShipmentAssignment?
  codCollection CODCollection?
  tasks         DeliveryAgentTask[] @relation("LocalShipmentTasks")

  @@index([merchantId])
  @@index([orderId])
  @@index([trackingNumber])
  @@index([createdAt])
  @@index([warehouseId])
  @@index([status])
  @@index([isCOD])
}

enum OrderUserRole {
  ORDERS
  STORE_MANAGER
  WAREHOUSE
  ACCOUNTANT
  DELIVERY_AGENT
}

enum RewardPenaltyType {
  REWARD
  PENALTY
}

model OrderUser {
  id       String        @id @default(cuid())
  username String        @unique
  password String // Hashed password
  name     String
  email    String?
  phone    String?
  employmentStartDate DateTime?
  employmentEndDate   DateTime?
  salaryAmount        Decimal?   @db.Decimal(12, 2)
  salaryCurrency      String?
  role     OrderUserRole @default(ORDERS)

  // Affiliate info
  affiliateName       String?  @unique
  affiliateCommission Decimal? @default(10.00) @db.Decimal(5, 2)

  // Order type assignment
  orderType String // "all", "cod", "prepaid", "specific_status"
  specificStatus String? // If orderType is "specific_status"

  // Settings
  isActive   Boolean @default(true)
  autoAssign Boolean @default(true) // Auto-assign orders when user logs in
  maxOrders  Int     @default(50) // Max orders to assign at once

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments          OrderAssignment[]
  prepAssignments      OrderPrepAssignment[]
  warehouseAssignments WarehouseAssignment[]
  deliveryAssignments  ShipmentAssignment[]  @relation("DeliveryAssignments")
  printerLink          OrderUserPrinterLink?
  servicePermissions   UserServicePermission[]
  recognitions         UserRecognition[]
  deliveryTasks        DeliveryAgentTask[] @relation("DeliveryAgentTasks")
  createdDeliveryTasks DeliveryAgentTask[] @relation("CreatedDeliveryAgentTasks")

  @@index([username])
  @@index([isActive])
}

model UserRecognition {
  id                String             @id @default(cuid())
  userId            String
  kind              RewardPenaltyType
  title             String
  description       String?            @db.Text
  points            Int                @default(0)
  effectiveDate     DateTime           @default(now())
  createdAt         DateTime           @default(now())
  createdById       String?
  createdByName     String?
  createdByUsername String?

  user OrderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, effectiveDate])
  @@index([createdAt])
}

model OrderUserPrinterLink {
  id            String   @id @default(cuid())
  userId        String   @unique
  printerId     Int
  printerName   String?
  computerId    Int?
  computerName  String?
  paperName     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user OrderUser @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// New table for multiple role support
model UserServicePermission {
  id         String   @id @default(cuid())
  userId     String
  serviceKey String
  createdAt  DateTime @default(now())

  user OrderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceKey])
  @@index([serviceKey])
}

model OrderAssignment {
  id String @id @default(cuid())

  // User
  userId String
  user   OrderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Order info
  merchantId  String
  orderId     String // Salla order ID
  orderNumber String // Human-readable order number
  orderData   Json // Full order data from Salla

  // Assignment details
  status      String    @default("assigned") // assigned, preparing, prepared, completed, cancelled, removed
  assignedAt  DateTime  @default(now())
  startedAt   DateTime? // When user started preparing
  completedAt DateTime? // When user marked as prepared
  removedAt   DateTime? // When order was removed (status changed in Salla)

  // Salla status tracking
  sallaStatus  String? // Current status in Salla
  sallaUpdated Boolean @default(false) // Whether we updated status in Salla

  notes String? @db.Text

  @@unique([userId, orderId])
  @@unique([merchantId, orderId])
  @@index([userId])
  @@index([status])
  @@index([merchantId, orderId])
  @@index([assignedAt])
}

model OrderPrepAssignment {
  id        String   @id @default(cuid())
  merchantId String

  userId   String
  userName String
  user     OrderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  orderId        String
  orderNumber    String?
  orderReference String?
  orderData      Json

  status      String   @default("assigned")
  assignedAt  DateTime @default(now())
  startedAt   DateTime?
  waitingAt   DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  lastStatusUpdateAt DateTime @updatedAt

  @@unique([merchantId, orderId])
  @@index([userId])
  @@index([status])
  @@index([assignedAt])
}

model HighPriorityOrder {
  id                String   @id @default(cuid())
  merchantId        String
  orderId           String
  orderNumber       String?
  customerName      String?
  reason            String?
  notes             String?  @db.Text
  createdById       String?
  createdByName     String?
  createdByUsername String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([merchantId, orderId])
  @@index([merchantId])
  @@index([orderId])
}

model OrderGiftFlag {
  id                String   @id @default(cuid())
  merchantId        String
  orderId           String
  orderNumber       String?
  reason            String?  @db.Text
  notes             String?  @db.Text
  createdById       String?
  createdByName     String?
  createdByUsername String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([merchantId, orderId])
  @@index([merchantId])
  @@index([orderId])
}

model Warehouse {
  id          String   @id @default(cuid())
  name        String
  code        String?  @unique
  location    String?
  description String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shipments      Shipment[]
  localShipments LocalShipment[]
  assignments    WarehouseAssignment[]

  @@index([isActive])
}

model WarehouseAssignment {
  id          String   @id @default(cuid())
  userId      String
  warehouseId String
  role        String?
  createdAt   DateTime @default(now())

  user      OrderUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([userId, warehouseId])
  @@index([warehouseId])
}

model OrderHistory {
  id String @id @default(cuid())

  // User
  userId   String
  userName String // Store user name for historical reference

  // Order info
  merchantId  String
  orderId     String // Salla order ID
  orderNumber String // Human-readable order number
  orderData   Json // Full order data from Salla

  // History details
  status     String // Final status: completed, cancelled, removed
  assignedAt DateTime
  startedAt  DateTime?
  finishedAt DateTime // When order was finished/removed

  // Duration tracking
  durationMinutes Int? // Total time spent on order

  // Salla status at finish
  finalSallaStatus String?

  notes String? @db.Text

  @@index([userId])
  @@index([status])
  @@index([merchantId, orderId])
  @@index([finishedAt])
  @@index([assignedAt])
}

model Expense {
  id String @id @default(cuid())

  // Basic info
  merchantId  String // Salla merchant ID
  title       String // Expense title/description
  description String? @db.Text // Optional detailed description

  // Financial details
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("SAR")

  // Category
  category String // e.g., "shipping", "packaging", "marketing", "operations", "other"

  // Date
  expenseDate DateTime @default(now()) // Date of expense

  // Attachments
  attachments Json? // Array of attachment URLs/metadata

  // Tracking
  createdBy String // User who created the expense
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Approval workflow (optional for future)
  status     String    @default("pending") // pending, approved, rejected
  approvedBy String? // User who approved/rejected
  approvedAt DateTime?

  // Notes
  notes String? @db.Text

  @@index([merchantId])
  @@index([category])
  @@index([expenseDate])
  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
}

model ShipmentAssignment {
  id String @id @default(cuid())

  // Shipment
  shipmentId String        @unique
  shipment   LocalShipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  // Delivery Agent
  deliveryAgentId String
  deliveryAgent   OrderUser @relation("DeliveryAssignments", fields: [deliveryAgentId], references: [id], onDelete: Cascade)

  // Assignment details
  status      String    @default("assigned") // assigned, picked_up, in_transit, delivered, failed, cancelled
  assignedAt  DateTime  @default(now())
  assignedBy  String? // Admin who assigned
  pickedUpAt  DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?
  cancelledAt DateTime?

  // Failure/cancellation details
  failureReason      String? @db.Text
  cancellationReason String? @db.Text

  // Delivery proof
  deliveryProofUrl   String? // Photo of delivery proof
  recipientName      String? // Name of person who received
  recipientSignature String? // Signature URL (if captured)

  // Notes
  notes String? @db.Text

  updatedAt DateTime @updatedAt

  @@index([deliveryAgentId])
  @@index([status])
  @@index([assignedAt])
  @@index([deliveredAt])
}

model CODCollection {
  id String @id @default(cuid())

  // Shipment
  shipmentId String        @unique
  shipment   LocalShipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  // Collection details
  collectionAmount Decimal  @db.Decimal(10, 2) // Amount to collect from customer
  collectedAmount  Decimal? @db.Decimal(10, 2) // Actual amount collected
  currency         String   @default("SAR")

  // Collection status
  status       String    @default("pending") // pending, collected, deposited, reconciled, failed
  collectedAt  DateTime? // When delivery agent collected from customer
  depositedAt  DateTime? // When delivery agent deposited to warehouse/company
  reconciledAt DateTime? // When accounting reconciled

  // Collected by
  collectedBy  String? // Delivery agent who collected
  depositedBy  String? // User who recorded deposit
  reconciledBy String? // Accountant who reconciled

  // Payment proof
  receiptUrl String? // Photo of receipt

  // Deposit details
  depositMethod    String? // "cash", "bank_transfer", "mobile_wallet"
  depositReference String? // Bank reference number or transaction ID
  depositNotes     String? @db.Text

  // Reconciliation details
  reconciliationNotes String?  @db.Text
  discrepancyAmount   Decimal? @db.Decimal(10, 2) // If collected != expected
  discrepancyReason   String?  @db.Text

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([collectedAt])
  @@index([depositedAt])
  @@index([reconciledAt])
  @@index([collectedBy])
  @@index([depositedBy])
  @@index([reconciledBy])
}

model DeliveryAgentTask {
  id             String        @id @default(cuid())
  deliveryAgentId String
  deliveryAgent  OrderUser     @relation("DeliveryAgentTasks", fields: [deliveryAgentId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   OrderUser? @relation("CreatedDeliveryAgentTasks", fields: [createdById], references: [id], onDelete: SetNull)
  createdByName     String?
  createdByUsername String?

  title         String
  requestType   String   @default("purchase")
  requestedItem String?
  quantity      Int?
  details       String?  @db.Text
  status        String   @default("pending") // pending, in_progress, completed, cancelled
  priority      String?  // low, normal, high
  dueDate       DateTime?
  completedAt   DateTime?
  completionNotes String? @db.Text

  relatedShipmentId String?
  relatedShipment   LocalShipment? @relation("LocalShipmentTasks", fields: [relatedShipmentId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deliveryAgentId])
  @@index([createdById])
  @@index([status])
  @@index([dueDate])
}
